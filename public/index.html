<!DOCTYPE html>
<html>
<head>
    <title>Quiz Game</title>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #2c3e50; color: white; text-align: center; }
        .container { background: #34495e; padding: 40px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 400px; }
        button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: background-color 0.2s; }
        button:hover { background: #2980b9; }
        button:disabled { background: #95a5a6; cursor: not-allowed; }
        #startGameBtn, #nextQuestionBtn { background: #2ecc71; }
        #startGameBtn:hover, #nextQuestionBtn:hover { background: #27ae60; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; margin: 5px; }
        h1, h2, h3 { margin-top: 0; }
        #gameCodeDisplay { color: #f1c40f; font-weight: bold; }
        #playerList, #leaderboard { list-style-type: none; padding: 0; }
        #playerList li, #leaderboard li { background: #2c3e50; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
        .hidden { display: none; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;}
        .options-grid button { padding: 20px; font-size: 18px; height: 80px; }
        .correct { background-color: #2ecc71 !important; }
        .incorrect { background-color: #e74c3c !important; }
    </style>
</head>
<body>

    <div class="container" id="initialView">
        <h1>Quiz Game</h1>
        <button id="createGameBtn">Create Game</button>
        <hr>
        <input type="text" id="nameInput" placeholder="Enter your name">
        <input type="text" id="codeInput" placeholder="Enter game code">
        <button id="joinGameBtn">Join Game</button>
    </div>

    <div class="container hidden" id="gameLobby">
        <h1>Lobby</h1>
        <h2>Game Code: <span id="gameCodeDisplay"></span></h2>
        <h3>Players:</h3>
        <ul id="playerList"></ul>
        <button id="startGameBtn">Start Game</button>
    </div>

    <div class="container hidden" id="questionView">
        <h2 id="questionText"></h2>
        <div class="options-grid" id="optionsContainer"></div>
    </div>
    
    <div class="container hidden" id="resultsView">
        <h2 id="resultText"></h2>
        <h3>Leaderboard</h3>
        <ul id="leaderboard"></ul>
        <button id="nextQuestionBtn" class="hidden">Next Question</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        const views = {
            initial: document.getElementById('initialView'),
            lobby: document.getElementById('gameLobby'),
            question: document.getElementById('questionView'),
            results: document.getElementById('resultsView')
        };
        const createGameBtn = document.getElementById('createGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const nameInput = document.getElementById('nameInput');
        const codeInput = document.getElementById('codeInput');
        const gameCodeDisplay = document.getElementById('gameCodeDisplay');
        const playerList = document.getElementById('playerList');
        const startGameBtn = document.getElementById('startGameBtn');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultText = document.getElementById('resultText');
        const leaderboard = document.getElementById('leaderboard');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');

        let myGameCode = '';
        let isHost = false;

        function showView(viewName) {
            Object.values(views).forEach(v => v.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
        }

        // === Event Emitters (Client -> Server) ===
        createGameBtn.addEventListener('click', () => {
            isHost = true;
            socket.emit('host:create_game');
        });

        joinGameBtn.addEventListener('click', () => {
            socket.emit('player:join_game', { gameCode: codeInput.value, playerName: nameInput.value });
        });
        
        startGameBtn.addEventListener('click', () => {
            socket.emit('host:start_game', { gameCode: myGameCode });
        });

        nextQuestionBtn.addEventListener('click', () => {
            socket.emit('host:next_question', { gameCode: myGameCode });
        });

    // NEW: Check for a gameCode in the URL when the page loads
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const gameCode = urlParams.get('gameCode');
        if (gameCode) {
            // If we are a host who just created a game, show the lobby immediately
            myGameCode = gameCode;
            isHost = true;
            gameCodeDisplay.textContent = gameCode;
            showView('lobby');
            // We can also update the player list, though it will be empty initially
            playerList.innerHTML = '<li>Waiting for players...</li>';
        }
    });

        // === Event Listeners (Server -> Client) ===
        socket.on('game_created', (data) => {
            myGameCode = data.gameCode;
            gameCodeDisplay.textContent = data.gameCode;
            showView('lobby');
        });

        socket.on('player_joined', (data) => {
            if (!myGameCode) myGameCode = codeInput.value;
            showView('lobby');
            playerList.innerHTML = '';
            data.players.forEach(p => { playerList.innerHTML += `<li>${p.name}</li>`; });
        });

        socket.on('question_started', (data) => {
            showView('question');
            questionText.textContent = data.question;
            optionsContainer.innerHTML = '';
            data.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.onclick = () => {
                    // Disable all buttons after one is clicked
                    optionsContainer.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    socket.emit('player:submit_answer', { gameCode: myGameCode, answer: option });
                };
                optionsContainer.appendChild(button);
            });
        });

        socket.on('show_results', (data) => {
            showView('results');

            // Visually mark the correct answer
            const buttons = optionsContainer.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent === data.correctAnswer) {
                    button.classList.add('correct');
                } else {
                    button.classList.add('incorrect');
                }
            });

            resultText.textContent = `The correct answer was: ${data.correctAnswer}`;
            
            // Update leaderboard
            leaderboard.innerHTML = '';
            data.players.forEach(p => {
                leaderboard.innerHTML += `<li><span>${p.name}</span> <span>${p.score} pts</span></li>`;
            });
            
            // Show "Next Question" button only for the host
            if (isHost) {
                nextQuestionBtn.classList.remove('hidden');
            }
        });

        socket.on('game_over', (data) => {
            showView('results');
            resultText.textContent = "Game Over! Final Scores:";
            nextQuestionBtn.classList.add('hidden'); // Hide next button

            leaderboard.innerHTML = '';
            data.players.forEach(p => {
                leaderboard.innerHTML += `<li><span>${p.name}</span> <span>${p.score} pts</span></li>`;
            });
        });

        socket.on('error', (data) => { alert(data.message); });
    </script>
</body>
</html>